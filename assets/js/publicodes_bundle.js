(()=>{"use strict";var e=Object.defineProperty,n=class extends Error{name;info;constructor(e,n,i,a){super(t(e,n,i,a)),this.name=e,this.info=i}},t=(e,n,t,i)=>{const a=/error/i.test(e);return`\n[ ${{SyntaxError:"Erreur syntaxique",EvaluationError:"Erreur d'√©valuation",SituationError:"Erreur lors de la mise √† jour de la situation",UnknownRule:"R√®gle inconnue",PrivateRule:"R√®gle priv√©e"}[e]??e} ]`+(t&&"dottedName"in t&&t.dottedName?.length?`\n‚û°Ô∏è  Dans la r√®gle "${t.dottedName}"`:"")+`\n${a?"‚úñÔ∏è":"‚ö†Ô∏è"}  ${n}`+(i?"\n"+(a?"    ":"‚ÑπÔ∏è  ")+i.message:"")},i=class extends n{constructor(e){super("InternalError",`\nErreur interne du moteur.\n\nCette erreur est le signe d'un bug dans publicodes. Pour nous aider √† le r√©soudre, vous pouvez copier ce texte dans un nouveau ticket : https://github.com/betagouv/mon-entreprise/issues/new.\n\npayload:\n${JSON.stringify(e,null,2)}\n`,e)}},a=class extends i{constructor(e){super({type:"UNREACHABLE_CODE",value:e})}};function r(e,n,i,a){e.warn[i]&&e.logger.warn(t("Avertissement",n,{dottedName:e.evaluatedRule??e.dottedName},a))}function o(e,n){e.warn.experimentalRules&&e.logger.warn(t("Avertissement","Cette r√®gle est taggu√©e comme experimentale. \n\nCela veut dire qu'elle peut √™tre modifi√©e, renomm√©e, ou supprim√©e sans qu'il n'y ait de changement de version majeure dans l'API.\n",{dottedName:n}))}function s(e,n,t){e.has(n)?e.get(n).add(t):e.set(n,new Set([t]))}var l=e=>{const n={};for(const t in e)n[t]=e[t];return n};function u(e,n=!0){return function t(i){const a=e(i,t);return!1===a?i:void 0===a?d(t,i):n?a:d(t,a)}}function c(e){function n(i){switch(e(i,n)){case"continue":return void d(t,i);case"stop":return}}const t=e=>(n(e),e);return n}var d=(e,n)=>{switch((n=p(e,n)).nodeKind){case"rule":return m(e,n);case"reference":case"constant":return n;case"arrondi":return V(e,n);case"simplifier unit√©":case"variable manquante":case"est non applicable":case"est non d√©fini":case"logarithme":return h(e,n);case"bar√®me":case"taux progressif":case"grille":return b(e,n);case"dur√©e":return x(e,n);case"r√©soudre r√©f√©rence circulaire":return y(e,n);case"inversion":return N(e,n);case"operation":return g(e,n);case"une possibilit√©":return I(e,n);case"contexte":return E(e,n);case"unit√©":return R(e,n);case"variations":return S(e,n);case"replacementRule":return f(e,n);case"texte":return w(e,n);case"condition":return $(e,n);default:throw new a(n)}},p=(e,n)=>{if(!("sourceMap"in n)||!n.sourceMap||!n.sourceMap.args)return n;const t=n.sourceMap,i={};for(const n in t.args){const a=t.args[n];i[n]=Array.isArray(a)?a.map(n=>e(n)):e(a)}return{...n,sourceMap:{...t,args:i}}},m=(e,n)=>{const t=l(n);t.suggestions={};for(const i in n.suggestions)t.suggestions[i]=e(n.suggestions[i]);return t.possibilities&&(t.possibilities=e(t.possibilities)),t.replacements=n.replacements.map(e),t.explanation={ruleDisabledByItsParent:n.explanation.ruleDisabledByItsParent,nullableParent:n.explanation.nullableParent?e(n.explanation.nullableParent):void 0,parents:n.explanation.parents.map(e),valeur:e(n.explanation.valeur)},t},f=(e,n)=>({...n,definitionRule:e(n.definitionRule),replacedReference:e(n.replacedReference),whiteListedNames:n.whiteListedNames.map(e),blackListedNames:n.blackListedNames.map(e)}),h=(e,n)=>{const t=l(n);return t.explanation=e(n.explanation),t};function v(e,n){return n.map(n=>({...n,...n.plafond&&{plafond:e(n.plafond)},..."montant"in n&&{montant:e(n.montant)},..."taux"in n&&{taux:e(n.taux)}}))}var b=(e,n)=>{const t=l(n);return t.explanation={assiette:e(n.explanation.assiette),multiplicateur:e(n.explanation.multiplicateur),tranches:v(e,n.explanation.tranches)},t},g=(e,n)=>{const t=l(n);return t.explanation=[e(n.explanation[0]),e(n.explanation[1])],t},x=(e,n)=>{const t=l(n);return t.explanation={depuis:e(n.explanation.depuis),"jusqu'√†":e(n.explanation["jusqu'√†"])},t},N=(e,n)=>{const t=l(n);return t.explanation={...n.explanation,inversionCandidates:n.explanation.inversionCandidates.map(e)},t},V=(e,n)=>{const t=l(n);return t.explanation={valeur:e(n.explanation.valeur),arrondi:e(n.explanation.arrondi)},t},y=(e,n)=>{const t=l(n);return t.explanation={...n.explanation,valeur:e(n.explanation.valeur)},t},w=(e,n)=>{const t=l(n);return t.explanation=n.explanation.map(n=>"string"==typeof n?n:e(n)),t},E=(e,n)=>{const t=l(n);return t.explanation={...t.explanation,contexte:n.explanation.contexte.map(([n,t])=>[e(n),e(t)]),valeur:e(n.explanation.valeur)},t},R=(e,n)=>{const t=l(n);return t.explanation=e(n.explanation),t},S=(e,n)=>{const t=l(n);return t.explanation=n.explanation.map(({condition:n,consequence:t})=>({condition:e(n),consequence:t&&e(t)})),t},$=(e,n)=>{const t=l(n);return t.explanation={si:e(n.explanation.si),alors:e(n.explanation.alors),sinon:e(n.explanation.sinon)},t},I=(e,n)=>{const t=l(n);return t.explanation=n.explanation.map(n=>{const t=e(n);return t.notApplicable=e(n.notApplicable),t}),t},k={constant:e=>e};function A(e,t){if(k??={},k[e])throw new n("EvaluationError",`Multiple evaluation functions registered for the nodeKind [4m${e}`,{dottedName:""});k[e]=t}var _={isNullable:void 0,type:void 0};function j(e,n,t){function i(e){if(!e||"object"!=typeof e)return _;if(t.has(e))return t.get(e);t.set(e,_);const a=function(e){switch(e.nodeKind){case"bar√®me":case"dur√©e":case"grille":case"taux progressif":case"inversion":case"r√©soudre r√©f√©rence circulaire":return{isNullable:!1,type:"number"};case"est non d√©fini":case"est non applicable":return{isNullable:!1,type:"boolean"};case"constant":return{isNullable:e.isNullable??null===e.nodeValue,type:e.type};case"operation":return{isNullable:["<","<=",">",">=","/","*"].includes(e.operationKind)?i(e.explanation[0]).isNullable||i(e.explanation[1]).isNullable:"-"===e.operationKind&&i(e.explanation[0]).isNullable,type:["<","<=",">",">=","=","!=","et","ou"].includes(e.operationKind)?"boolean":"number"};case"replacementRule":return{isNullable:!1,type:void 0};case"texte":return{isNullable:!1,type:"string"};case"arrondi":return{type:"number",isNullable:i(e.explanation.valeur).isNullable};case"logarithme":case"unit√©":case"simplifier unit√©":return{type:"number",isNullable:i(e.explanation).isNullable};case"contexte":return i(e.explanation.valeur);case"une possibilit√©":return"reference"===e.type?{isNullable:e.explanation.every(e=>i(e).isNullable),type:"string"}:{isNullable:!1,type:e.type};case"rule":{const n=i(e.explanation.valeur);if(e.possibilities){const t=i(e.possibilities);return{isNullable:n.isNullable||t.isNullable,type:t.type}}if(void 0!==n.type)return n;let t="nombre"===e.rawNode.type?"number":"texte"===e.rawNode.type?"string":"date"===e.rawNode.type?"date":"bool√©en"===e.rawNode.type?"boolean":void 0;return!t&&e.rawNode.question&&(t="boolean"),{isNullable:n.isNullable,type:t}}case"variable manquante":return i(e.explanation);case"condition":return{isNullable:[e.explanation.si,e.explanation.alors,e.explanation.sinon].some(e=>i(e).isNullable),type:i(e.explanation.alors).type??i(e.explanation.sinon).type};case"variations":{const n=e.explanation.map(({consequence:e})=>i(e));return{isNullable:n.some(e=>e.isNullable),type:n.map(e=>e.type).find(e=>void 0!==e)}}case"reference":return i(n[e.dottedName])}}(e);return t.set(e,a),a}return e.forEach(e=>{const t=n[e];i(t),t.explanation.parents.forEach(i)}),t}var O=e=>"missingVariables"in e?e.missingVariables:{},K=(e={})=>Object.fromEntries(Object.entries(e).map(([e,n])=>[e,n+1])),L=(e={},n={})=>Object.fromEntries([...Object.keys(e),...Object.keys(n)].map(t=>[t,(e[t]??0)+(n[t]??0)])),T=e=>e.map(O).reduce(L,{}),D=e=>({nodeValue:e,type:typeof e,isDefault:!0,nodeKind:"constant"}),M={nodeKind:"constant",nodeValue:null,missingVariables:{},type:void 0,isNullable:!0},P={nodeKind:"constant",nodeValue:void 0,missingVariables:{},type:void 0,isNullable:!1},C={...P,type:"number"};function U(e,t,i){let a,r;function o(o,s){a??=kt(i,Ft({dottedName:"INLINE_MECANISM"})),r??={};for(const e in t)"par d√©faut"in t[e]&&(r[e]=kt(t[e]["par d√©faut"],Ft({})));1===Object.keys(t).length&&"valeur"in t&&(o={valeur:o});const l={};for(const e in o)l[e]=kt(o[e],s);const c=u(i=>{if("reference"!==i.nodeKind||!(i.name in t))return;const a=i.name;if(a in l)return l[a];if(a in r)return r[a];throw new n("SyntaxError",`Il manque la cl√© '${a} dans le m√©canisme ${e}`,{dottedName:a})})(a);return c.sourceMap={mecanismName:e,args:l},c}return o.nom=e,Object.assign(o,"name",{value:`parse${F(e)}Inline`})}function q(e,n,t){function i(i,a){1===Object.keys(n).length&&"valeur"in n&&(i={valeur:i});const r={};for(const e in i){const n=i[e];r[e]=Array.isArray(n)?n.map(e=>kt(e,a)):kt(n,a)}const o=kt(t(r),a);return o.sourceMap={mecanismName:e,args:r},o}return i.nom=e,Object.assign(i,"name",{value:`parse${F(e)}Inline`})}function F(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,e=>e.toUpperCase()).replace(/\s+/g,"")}var z=U("abattement",{abattement:{},valeur:{}},{"-":["valeur","abattement"],plancher:0}),B=U("applicable si",{"applicable si":{},valeur:{}},{condition:{si:"applicable si != non",alors:"valeur",sinon:M}});function J(e,n=e=>e){if(e.includes("/ "))throw new Error(`L'unit√© "${e}" ne doit pas contenir d'espace apr√®s "/"`);const[t,...i]=e.split("/"),a=e=>function(e){const n=Y(e);return Object.entries(n).flatMap(([e,n])=>Array(n).fill(e))}(e.trim().split(".").filter(Boolean).map(e=>n(e)));return{numerators:a(t),denominators:i.flatMap(e=>a(e))}}var W=/(\d+)(?!.*[A-Za-z])/g;function Y(e){const n={};return e.forEach(e=>{const t=e.match(W);if(null!=t){const i=t[0],a=e.split(i)[0];n[a]=(n[a]??0)+ +i}else n[e]=(n[e]??0)+1}),n}var Z=(e,n,t=e=>e)=>function(e){const n=Y(e);return Object.entries(n).map(([e,n])=>n>1?`${e}${n}`:e)}(e.map(e=>t(e,n))).join(".");function G(e,n=2,t=e=>e){if(null===e||"object"!=typeof e)return"string"==typeof e?t(e,n):e;const i=ne(e),{numerators:a=[],denominators:r=[]}=i,o=a.length>0,s=r.length>0;return o||s?o&&!s?Z(a,n,t):!o&&s?`/${Z(r,1,t)}`:`${Z(a,2,t)}/${Z(r,1,t)}`:""}var H={numerators:[],denominators:[]},Q=(e,t)=>{if("/"===e){if(2!==t.length)throw new n("InternalError","Infer units of a division with units.length !== 2)",{});return Q("*",[t[0]||H,{numerators:(t[1]||H).denominators,denominators:(t[1]||H).numerators}])}const i=t.filter(Boolean);return i.length<=1?i[0]:"*"===e?ne({numerators:i.flatMap(e=>e?.numerators??[]),denominators:i.flatMap(e=>e?.denominators??[])}):"-"===e||"+"===e?t.find(e=>e):void 0},X=(e,n)=>Array.isArray(e)&&Array.isArray(n)?e.length===n.length&&e.every((t,i)=>e[i]===n[i]):e===n,ee=(e,n=X)=>t=>{const i=t.findIndex(t=>n(t,e));return t.filter((e,n)=>n!==i)},ne=(e,n=X)=>[...e.numerators,...e.denominators].reduce(({numerators:e,denominators:t},i)=>e.find(e=>n(i,e))&&t.find(e=>n(i,e))?{numerators:ee(i,n)(e),denominators:ee(i,n)(t)}:{numerators:e,denominators:t},e),te={"mois/an":12,"jour/an":365,"jour/mois":365/12,"trimestre/an":4,"mois/trimestre":3,"jour/trimestre":91.25,"‚Ç¨/k‚Ç¨":1e3,"g/kg":1e3,"mg/g":1e3,"mg/kg":10**6,"m/km":1e3,"cm/m":100,"mm/cm":10,"mm/m":1e3,"cm/km":10**5,"mm/km":10**6};function ie(e,n){return te[`${n}/${e}`]||te[`${e}/${n}`]&&1/te[`${e}/${n}`]}function ae(e,n){let t=100**(n.filter(e=>"%"===e).length-e.filter(e=>"%"===e).length);return[t]=e.reduce(([e,n],t)=>{const i=n.findIndex(e=>!!ie(t,e));return[e*(ie(t,n[i])||1),[...n.slice(0,i+1),...n.slice(i+1)]]},[t,n]),t}var re={"kW.h":"kWh","mn/h":"noeud"};function oe(e,t,i){const a=G(e),r=G(t);if(!function(e,n){return!(!e||!n||e!==n&&e!==re[n]&&n!==re[e])}(a,r)&&!function(e,n){if(null==e||null==n)return!0;const[t,i,a,r]=[e.numerators,e.denominators,n.numerators,n.denominators].map(e=>e.reduce((e,n)=>{const t=le.findIndex(e=>e.has(n)),i=-1===t?n:""+t;return{...e,[i]:1+(e[i]??0)}},{})),o=[t,i,a,r].map(Object.keys).flat();return(s=o,[...new Set(s)]).every(e=>(t[e]||0)-(i[e]||0)===(a[e]||0)-(r[e]||0)||"%"===e);var s}(e,t))throw new n("EngineError",`Impossible de convertir l'unit√© '${a}' en '${r}'`,{});if(!i)return i;if(void 0===e)return i;const[o,s]=pe(e||H),[l,u]=pe(t||H);return ce(i*s/u*ae(o.numerators,l.numerators)*ae(l.denominators,o.denominators))}var se,le=(se=te,Object.keys(se).reduce((e,t)=>{const[i,a]=t.split("/"),r=e.findIndex(e=>e.has(i)),o=e.findIndex(e=>e.has(a));if(r>-1&&o>-1&&r!==o)throw new n("EngineError",`Invalid ratio ${t}`,{});return-1===r&&-1===o?e.push(new Set([i,a])):r>-1?e[r].add(a):o>-1&&e[o].add(i),e},[]));function ue(e,n){return e===n||le.some(t=>t.has(e)&&t.has(n))}function ce(e){return+e.toFixed(16)}function de(e){const{numerators:n,denominators:t}=ne(e,ue);return n.length&&n.every(e=>"%"===e)?{numerators:["%"],denominators:t}:me({numerators:n,denominators:t})}function pe(e,n=1){const t=ae(e.numerators,e.denominators);return[ne(me(e),ue),n?ce(n*t):n]}var me=e=>({numerators:e.numerators.filter(e=>"%"!==e),denominators:e.denominators.filter(e=>"%"!==e)});function fe(e,n){return Math.round((e+Number.EPSILON)*10**n)/10**n}function he(e,n){return{explanation:{valeur:kt(e.valeur,n),arrondi:kt(e.arrondi,n)},nodeKind:he.nom}}function ve(e){return e.unit?be(de(e.unit),e):e}function be(e,n){return{...n,nodeValue:n.unit&&"number"==typeof n.nodeValue?oe(n.unit,e,n.nodeValue):n.nodeValue,unit:e}}function ge(e,n,t){if(void 0===t.nodeValue||null===t.nodeValue)return!0;switch(n.type){case"number":return n.explanation.some(e=>"unit"in e?be(e.unit,t).nodeValue===e.nodeValue:e.nodeValue===t.nodeValue);case"string":return n.explanation.some(e=>e.publicodesValue===`'${t.nodeValue}'`);case"reference":return e.evaluateNode(n).explanation.some(e=>e.publicodesValue===`'${t.nodeValue}'`&&!0!==e.notApplicable.nodeValue)}}he.nom="arrondi",A(he.nom,function(e){const t=ve(this.evaluateNode(e.explanation.valeur)),i=t.nodeValue;let a=e.explanation.arrondi;if(!1!==i&&(a=this.evaluateNode(a),"number"==typeof a.nodeValue&&!G(a.unit)?.match(/d√©cimales?/)))throw new n("EvaluationError",`L'unit√© ${G(a.unit)} de l'arrondi est inconnu. Vous devez utiliser l'unit√© ‚Äúd√©cimales‚Äù`,{dottedName:this.cache._meta.evaluationRuleStack[0]});return{...e,nodeValue:"number"==typeof t.nodeValue&&"nodeValue"in a?"number"==typeof a.nodeValue?fe(t.nodeValue,a.nodeValue):!0===a.nodeValue?fe(t.nodeValue,0):void 0===a.nodeValue?void 0:t.nodeValue:t.nodeValue,explanation:{valeur:t,arrondi:a},missingVariables:T([t,a]),unit:t.unit}}),A("logarithme",function(e){const t=ve(this.evaluateNode(e.explanation));let i;if(null===t.nodeValue||void 0===t.nodeValue)i=t.nodeValue;else{if("number"!=typeof t.nodeValue)throw new n("EvaluationError",`Impossible de calculer le logarithme de ${t.nodeValue}`,{dottedName:this.cache._meta.evaluationRuleStack[0]});i=Math.log(t.nodeValue)}return{...e,nodeValue:i,missingVariables:t.missingVariables,explanation:t}});var xe=({style:e,maximumFractionDigits:n=2,minimumFractionDigits:t=0,language:i})=>a=>{const r="currency"===e&&n>=2&&0===t&&!Number.isInteger(a)?2:t;return Intl.NumberFormat(i,{style:e,currency:"EUR",maximumFractionDigits:n,minimumFractionDigits:r}).format(a)},Ne={fr:{true:"oui",false:"non"},en:{true:"yes",false:"no"}};function Ve(e,n){return{explanation:kt(e,n),nodeKind:"est non applicable"}}Ve.nom="est non applicable";var ye=e=>({nodeKind:"est non applicable",explanation:e});A("est non applicable",function(e){const n=e.explanation;if(!1===this.context.nodesTypes.get(n)?.isNullable&&"rule"!==n.nodeKind&&"reference"!==n.nodeKind)return{...e,nodeValue:!1,missingVariables:{}};if(this.cache.nodes.has(n)&&void 0!==this.cache.nodes.get(n))return{...e,nodeValue:null===this.cache.nodes.get(n)?.nodeValue,missingVariables:this.cache.nodes.get(n)?.missingVariables??{}};switch(n.nodeKind){case"rule":{const{ruleDisabledByItsParent:t,parentMissingVariables:i}=Xe(this,n);if(t)return{...e,nodeValue:!0,missingVariables:i};const a=this.evaluateNode(ye(n.explanation.valeur)),r=L(i,a.missingVariables);return!1===a.nodeValue&&this.context.nodesTypes.get(this.context.parsedRules[`${n.dottedName} . $SITUATION`])?.isNullable&&!Object.keys(a.missingVariables).length&&(r[n.dottedName]=1),{...e,nodeValue:a.nodeValue,missingVariables:r}}case"reference":return{...this.evaluateNode(ye(this.context.parsedRules[n.dottedName])),...e};case"condition":return{...this.evaluateNode({...n,explanation:{si:n.explanation.si,alors:ye(n.explanation.alors),sinon:ye(n.explanation.sinon)}}),...e}}const t=this.evaluateNode(n);return{...e,nodeValue:void 0===t.nodeValue?void 0:null===t.nodeValue,missingVariables:t.missingVariables}});var we={nodeKind:"constant",type:"boolean",nodeValue:!1};function Ee(e,n){return null!=e&&Object.prototype.hasOwnProperty.call(e,n)}function Re(e){return function(){return e}}A("une possibilit√©",function(e){const n=l(e);if("reference"!==e.type)return n.missingVariables={},n.nodeValue=void 0,n;const t=e.explanation.map(e=>{const n=this.evaluateNode(e.notApplicable);return{...e,notApplicable:n,missingVariables:n.missingVariables}});n.explanation=t,n.missingVariables=T(t.map(e=>e.notApplicable));const i=t.filter(e=>!0!==e.notApplicable.nodeValue);return 0===i.length?(n.nodeValue=null,n):1===i.length?(n.nodeValue=i[0].nodeValue,n):(n.nodeValue=void 0,n)}),((n,t)=>{for(var i in t)e(n,i,{get:t[i],enumerable:!0})})({},{contextNameToDottedName:()=>Pe,cyclicDependencies:()=>je,decodeRuleName:()=>Me,disambiguateReference:()=>We,disambiguateReferenceNode:()=>Ge,encodeRuleName:()=>De,findCommonAncestor:()=>Fe,getChildrenRules:()=>qe,isAccessible:()=>ze,isExperimental:()=>Be,nameLeaf:()=>Te,ruleParent:()=>Ce,ruleParents:()=>Ue,ruleWithDedicatedDocumentationPage:()=>Ye,updateReferencesMapsFromReferenceNode:()=>Ze});var Se=(e,n)=>{e[n]?e[n]++:e[n]=1},$e=(e,n)=>{--e[n]||delete e[n]},Ie=(e,n,t,i)=>{let a=""+n,r=""+t;if(!e&&a>r){const e=a;a=r,r=e}return a+""+r+""+(void 0===i?"\0":i)},ke=(e,n)=>Ie(e,n.v,n.w,n.name),Ae=class{_nodeCount=0;_edgeCount=0;_isDirected;_label;_defaultNodeLabelFn;_defaultEdgeLabelFn;_nodes;_in;_preds;_out;_sucs;_edgeObjs;_edgeLabels;constructor(e={}){this._isDirected=!Ee(e,"directed")||e.directed,this._label=void 0,this._defaultNodeLabelFn=Re(void 0),this._defaultEdgeLabelFn=Re(void 0),this._nodes={},this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}isDirected(){return this._isDirected}setGraph(e){return this._label=e,this}graph(){return this._label}nodeCount(){return this._nodeCount}nodes(){return Object.keys(this._nodes)}setNode(e,n=void 0){return Ee(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=n),this):(this._nodes[e]=arguments.length>1?n:this._defaultNodeLabelFn(e),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)}setNodes(e,n){return e.forEach(e=>{void 0!==n?this.setNode(e,n):this.setNode(e)}),this}node(e){return this._nodes[e]}hasNode(e){return Ee(this._nodes,e)}successors(e){const n=this._sucs[e];if(n)return Object.keys(n)}edgeCount(){return this._edgeCount}edges(){return Object.values(this._edgeObjs)}setEdge(e,n,t=void 0,i=void 0){e=""+e,n=""+n;const a=Ie(this._isDirected,e,n,i);if(Ee(this._edgeLabels,a))return void 0!==t&&(this._edgeLabels[a]=t),this;this.setNode(e),this.setNode(n),this._edgeLabels[a]=void 0!==t?t:this._defaultEdgeLabelFn(e,n,i);const r=((e,n,t,i)=>{let a=""+n,r=""+t;if(!e&&a>r){const e=a;a=r,r=e}const o={v:a,w:r};return i&&(o.name=i),o})(this._isDirected,e,n,i);return e=r.v,n=r.w,Object.freeze(r),this._edgeObjs[a]=r,Se(this._preds[n],e),Se(this._sucs[e],n),this._in[n][a]=r,this._out[e][a]=r,this._edgeCount++,this}edge(e,n,t){const i=1===arguments.length?ke(this._isDirected,arguments[0]):Ie(this._isDirected,e,n,t);return this._edgeLabels[i]}hasEdge(e,n,t){const i=1===arguments.length?ke(this._isDirected,arguments[0]):Ie(this._isDirected,e,n,t);return Ee(this._edgeLabels,i)}removeEdge(e,n,t){const i=1===arguments.length?ke(this._isDirected,arguments[0]):Ie(this._isDirected,e,n,t),a=this._edgeObjs[i];return a&&(e=a.v,n=a.w,delete this._edgeLabels[i],delete this._edgeObjs[i],$e(this._preds[n],e),$e(this._sucs[e],n),delete this._in[n][i],delete this._out[e][i],this._edgeCount--),this}outEdges(e,n=void 0){const t=this._out[e];if(t){const e=Object.values(t);return void 0===n?e:e.filter(function(e){return e.w===n})}}};function _e(e){let n=0;const t=[],i={},a=[];function r(o){const s=i[o]={onStack:!0,lowlink:n,index:n++};if(t.push(o),e.successors(o).forEach(function(e){Object.prototype.hasOwnProperty.call(i,e)?i[e].onStack&&(s.lowlink=Math.min(s.lowlink,i[e].index)):(r(e),s.lowlink=Math.min(s.lowlink,i[e].lowlink))}),s.lowlink===s.index){const e=[];let n;do{n=t.pop(),i[n].onStack=!1,e.push(n)}while(o!==n);a.push(e)}}return e.nodes().forEach(function(e){Object.prototype.hasOwnProperty.call(i,e)||r(e)}),a}function je(e){const{referencesMaps:n}=Bt(e),t=function(e){const n=new Ae;return[...e.entries()].forEach(([e,t])=>{t.forEach(t=>{n.setEdge(e,t)})}),n}(n.referencesIn);var i;const a=_e(i=t).filter(function(e){return e.length>1||1===e.length&&i.hasEdge(e[0],e[0])}).map(e=>e.reverse()),r=a.map(e=>function(e,n){function*t(e){let t=e;for(;;)yield n[t++%n.length]}const i=[];for(let a=0;a<n.length;a++){const n=[];let r;for(const i of t(a))if(void 0===r)n.push(i),r=i;else if(e.get(r)?.has(i)){if(n.includes(i)){n.splice(0,n.lastIndexOf(i));break}n.push(i),r=i}i.push(n)}return i.reduce((e,n)=>n.length>e.length?e:n)}(n.referencesIn,e)),o=a.map((e,n)=>function(e,n,t){const i=new Set;return n.forEach(a=>{e.outEdges(a).filter(({w:e})=>n.includes(e)).forEach(({v:e,w:n})=>{i.add(`"${e}" -> "${n}"`+(Oe(t,e,n)?" [color=red]":""))})}),`digraph Cycle {\n\t${[...i].join(";\n\t")};\n}`}(t,e,r[n]));return[r,o]}var Oe=(e,n,t)=>{for(let i=0;i<e.length+1;i++)if(n===e[i]&&t===e[(i+1)%e.length])return!0;return!1},Ke=e=>e.split(" . "),Le=e=>e.join(" . "),Te=e=>Ke(e).slice(-1)?.[0],De=e=>e?.replace(/\s\.\s/g,"/").replace(/-/g,"‚Äë").replace(/\s/g,"-"),Me=e=>e.replace(/\//g," . ").replace(/-/g," ").replace(/\u2011/g,"-"),Pe=e=>e.endsWith("$SITUATION")?Ce(e):e,Ce=e=>Le(Ke(e).slice(0,-1));function Ue(e){return Ke(e).slice(0,-1).map((e,n,t)=>Le(t.slice(0,n+1))).reverse()}var qe=(e,n)=>Object.keys(e).filter(e=>e.startsWith(n)&&Ke(e).length===Ke(n).length+1);function Fe(e,n){const t=Ke(e),i=Ke(n),a=t.findIndex((e,n)=>i[n]!==e);return-1===a?e:Le(t.slice(0,a))}function ze(e,t,i){if(!(i in e))throw new n("InternalError",`La r√®gle "${i}" n'existe pas`,{dottedName:i});const a=Fe(t,i),r=[i,...Ue(i),""];return r.slice(0,Math.max(r.indexOf(a)-1,0)).every(n=>!(n in e)||!1===e[n].private)}function Be(e,t){if(!(t in e))throw new n("InternalError",`La r√®gle "${t}" n'existe pas`,{dottedName:t});return[t,...Ue(t)].some(n=>n in e&&"oui"===e[n].rawNode?.experimental)}function Je(e,n){return e?e+" . "+n:n}function We(e,t="",i){const a=Ue(t);if(a.push(t),i.startsWith("^ . ")){const e=i.match(/^(\^ \. )+/)[0].length/4;i=i.replace(/^(\^ \. )+/,""),a.splice(-e)}const r=a.pop();a.unshift(r),a.push("");const o=a.find(n=>{const a=Je(n,i);return a in e&&a!==t&&ze(e,t,a)});if(void 0!==o)return Je(o,i);if(t.endsWith(i))return t;const s=a.map(e=>Je(e,i));if(s.every(n=>!(n in e)))throw new n("SyntaxError",`La r√©f√©rence "${i}" est introuvable.\nV√©rifiez que l'orthographe et l'espace de nom sont corrects`,{dottedName:Pe(t)});throw new n("SyntaxError",`La r√®gle "${s.find(n=>n in e)}" n'est pas accessible depuis "${t}".\n\tCela vient du fait qu'elle est priv√©e ou qu'un de ses parent est priv√©`,{dottedName:Pe(t)})}function Ye(e){return!0!==e.virtualRule&&"groupe"!==e.type&&"texte"!==e.type&&"paragraphe"!==e.type&&"notification"!==e.type}function Ze(e,n,t){"reference"===e.nodeKind&&(s(n.referencesIn,t??e.contextDottedName,e.dottedName),s(n.rulesThatUse,e.dottedName,t??e.contextDottedName))}function Ge(e,n){if("reference"===e.nodeKind)return e.dottedName||(e.dottedName=We(n,e.contextDottedName,e.name),e.title=n[e.dottedName].title,e.acronym=n[e.dottedName].rawNode.acronyme),e}function He(e,t,i){const a="oui"===t.priv√©||e.startsWith("[priv√©] ");e=e.replace(/^\[priv√©\] /,"");const o=[i.dottedName,e].filter(Boolean).join(" . "),s=Te(o),u=function(e){return e&&e[0].toUpperCase()+e.slice(1)}(t.titre??s);if(i.parsedRules[o])throw new n("EvaluationError",`La r√©f√©rence '${o}' a d√©j√† √©t√© d√©finie`,{dottedName:o});const c=i.dottedName;i.dottedName=o,i.parsedRules[o]=void 0;const d={};d.avec=Object.assign({},t.avec);const p=function(e,t,i){let a,o=!1;if(e.valeur&&e.valeur["une possibilit√©"]&&(o=e.valeur["une possibilit√©"],r(t,"La cl√© 'une possibilit√©' √† l'int√©rieur de la cl√© 'valeur' est d√©pr√©ci√©e, veuillez la d√©placer\nau niveau sup√©rieur.","deprecatedSyntax"),delete e.valeur["une possibilit√©"]),e.formule?.["une possibilit√©"]&&(o=e.formule["une possibilit√©"],r(t,"La cl√© 'une possibilit√©' √† l'int√©rieur de la cl√© 'formule' est d√©pr√©ci√©e, veuillez la d√©placer au niveau sup√©rieur.","deprecatedSyntax"),delete e.formule["une possibilit√©"]),"une possibilit√©"in e){if(!e["une possibilit√©"])throw new n("SyntaxError","La cl√© 'une possibilit√©' ne peut pas √™tre vide",t);o=e["une possibilit√©"]}if(!o)return null;if("possibilit√©s"in o&&(o["choix obligatoire"]?(r(t,"Les cl√©s 'choix obligatoire' et 'possibilit√©s' √† l'int√©rieur de 'une possibilit√©' sont d√©pr√©ci√©es. \n\nD√©placez les possibilit√©s directement √† la racine de 'une possibilit√©' ."+("non"===o["choix obligatoire"]?`Pour ajouter un choix ¬´ aucun ¬ª, ¬´ non applicable ¬ª ou ¬´ autre ¬ª √† la liste des possibilit√©, cr√©er explicitement une r√®gle d√©di√©e. Par exemple : \n\n\`une possibilit√©: [${o.possibilit√©s.join(", ")}, aucun]\`\n`:""),"deprecatedSyntax"),a=o["choix obligatoire"]):r(t,"La cl√© 'possibilit√©s' √† l'int√©rieur de 'une possibilit√©' est d√©pr√©ci√©e. \n\nD√©placez les possibilit√©s directement √† la racine de 'une possibilit√©'\n","deprecatedSyntax"),o=o["possibilit√©s"]),!o)return null;if(!o.length)throw new n("SyntaxError","La cl√© 'une possibilit√©' doit √™tre un tableau contenant au moins un √©l√©ment",t);const s=function(e,t,i){let a;const r=e.map(e=>{const r=function(e,t,i){if("object"==typeof e){if(1!==Object.keys(e).length)throw new n("SyntaxError","Il ne peut y avoir qu'une seule d√©finition de r√®gle par possibilit√©.",{dottedName:i.dottedName});const[a,r]=Object.entries(e)[0];if(a in t)throw new n("SyntaxError",`La r√®gle "${a}" est d√©j√† d√©finie`,{dottedName:i.dottedName});t[a]=r,e=a}const a=kt(e,i);if("constant"!==a.nodeKind&&"reference"!==a.nodeKind)throw new n("SyntaxError",`"${e}" n'est pas une constante ou une r√©f√©rence.\nLes choix possibles doivent √™tre des constantes ou des r√©f√©rences.`,i);if("reference"===a.nodeKind)return{...a,type:"reference",notApplicable:i.flag?.filterNotApplicablePossibilities?Ve(l(a),i):we,nodeValue:a.name,publicodesValue:`'${a.name}'`};if("string"!==a.type&&"number"!==a.type)throw new n("SyntaxError","Les choix possibles doivent √™tre des nombres ou des cha√Ænes de caract√®res.",i);return{...a,type:a.type,notApplicable:we,publicodesValue:"string"===a.type?`'${a.nodeValue}'`:a.rawNode,nodeValue:a.nodeValue,..."unit"in a&&{unit:a.unit}}}(e,t,i);if(a??=r,r.type!==a.type)throw new n("SyntaxError",`Les possibilit√©s doivent √™tre toutes du m√™me type.\n${a.publicodesValue} et ${r.publicodesValue} ne sont pas du m√™me type.`,i);if("number"===a.type&&"number"===r.type&&a.unit){try{oe(r.unit,a.unit,0)}catch(e){throw new n("SyntaxError",`Les possibilit√©s doivent √™tre toutes dans la m√™me classe d'unit√©.\n\n\t\t\t\t\t${G(r.unit)} n'est pas convertible en ${G(a.unit)}.`,i)}a=r}return r});return a??=r[0],{nodeKind:"une possibilit√©",..."unit"in a?{unit:a.unit}:{},type:a.type,explanation:r}}(o,i,t);let u;if(a&&(s["choix obligatoire"]=a),u="number"===s.type?s.explanation.map(e=>oe(e.unit,s.unit,e.nodeValue)):s.explanation.map(e=>e.publicodesValue),new Set(u).size!==u.length){const e=u.map((e,n,t)=>t.indexOf(e)!==n?s.explanation[n].publicodesValue:null).filter(Boolean);throw new n("SyntaxError",`Il ne doit pas y avoir de doublons parmi les possibilit√©s.\nLes valeurs suivantes sont en double : ${e.join(", ")}.`,t)}return s}(t,i,d.avec);for(const e in t)Kt.includes(e)&&(d[e]??=t[e]);if("formule"in t&&(d.valeur=t.formule),!a&&!o.endsWith("$SITUATION")){d["dans la situation"]=`${o} . $SITUATION`;const e=l(P);e.isNullable="oui"===t["possiblement non applicable"],d.avec["[priv√©] $SITUATION"]={valeur:e},null!=d["par d√©faut"]&&(d["par d√©faut"]={valeur:d["par d√©faut"],"variable manquante":o})}const m={valeur:kt(d,i),parents:i.flag.automaticNamespaceDisabling?Ue(o).map(e=>({dottedName:e,nodeKind:"reference",contextDottedName:i.dottedName})):[]},f={};if(t.suggestions)for(const e in t.suggestions)f[e]=kt(t.suggestions[e],i);return i.parsedRules[o]={dottedName:o,replacements:[...Mt(t["rend non applicable"],i),...Dt(t.remplace,i)],title:u,private:a,suggestions:f,nodeKind:"rule",possibilities:p,explanation:m,rawNode:t,virtualRule:a},i.dottedName=c,i.parsedRules[o]}function Qe(e,t){for(const i in e){let a=e[i];if("string"!=typeof a&&"number"!=typeof a||(a={valeur:`${a}`}),"object"!=typeof a)throw new n("SyntaxError",`Rule ${i} is incorrectly written. Please give it a proper value.\n ${a}`,{dottedName:i});He(i,null===a?{}:l(a),t)}}function Xe(e,n){if(n.dottedName.endsWith("$SITUATION"))return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};const t=e.context.nodesTypes,i=n.explanation.parents.find(e=>t.get(e)?.isNullable||"boolean"===t.get(e)?.type);if(!i)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};if(!e.cache._meta.parentRuleStack.includes(n.dottedName)){e.cache._meta.parentRuleStack.unshift(n.dottedName);let a=D(!1);if(t.get(i)?.isNullable&&(a=e.evaluateNode({nodeKind:"est non applicable",explanation:i})),!0!==a.nodeValue&&"boolean"===t.get(i)?.type&&(a=e.evaluateNode({nodeKind:"operation",operator:"=",operationKind:"=",explanation:[i,D(!1)]})),e.cache._meta.parentRuleStack.shift(),!0===a.nodeValue)return{ruleDisabledByItsParent:!0,parentMissingVariables:a.missingVariables??{},nullableParent:i}}let a={};if("boolean"===t.get(i)?.type){const n=e.evaluateNode(i);return a=n.missingVariables??{},{ruleDisabledByItsParent:!1===n.nodeValue,parentMissingVariables:a,nullableParent:i}}return{ruleDisabledByItsParent:!1,parentMissingVariables:a,nullableParent:i}}function en(e,n){return Qe(e.avec,n),kt(e.valeur,n)}A("rule",function(e){e.dottedName.endsWith("$SITUATION")||e.dottedName.includes("$INTERNAL")||(this.context.evaluatedRule=e.dottedName);const{ruleDisabledByItsParent:t,nullableParent:i,parentMissingVariables:a}=Xe(this,e),o={...e.explanation,nullableParent:i,ruleDisabledByItsParent:t};if(t)return{...e,nodeValue:null,missingVariables:a,explanation:o};if(this.cache._meta.evaluationRuleStack.filter(n=>n===e.dottedName).length>1){const t=this.cache._meta.evaluationRuleStack.indexOf(e.dottedName),i=[...this.cache._meta.evaluationRuleStack.slice(0,t+1).reverse(),e.dottedName],s=`\nUn cycle a √©t√© d√©tect√© lors de l'√©valuation de cette r√®gle:\n${i.join(i.length>5?"\n ‚Üí ":" ‚Üí ")}\n\nCela vient probablement d'une erreur dans votre mod√®le.\n\nSi le cycle est voulu, vous pouvez indiquer au moteur de r√©soudre la r√©f√©rence circulaire en trouvant le point fixe de la fonction. Pour cela, ajoutez l'attribut suivant niveau de la r√®gle :\n\n\t${e.dottedName}:\n\t\tr√©soudre la r√©f√©rence circulaire: oui"\n\t\t...\n`;if(!this.cache._meta.parentRuleStack.length||this.cache._meta.parentRuleStack.some(n=>!n.startsWith(e.dottedName))){if(this.context.strict.noCycleRuntime)throw new n("EvaluationError",s,{dottedName:e.dottedName});r(this.context,s,"cyclicReferences")}return{...e,nodeValue:void 0,missingVariables:a,explanation:o}}this.cache._meta.evaluationRuleStack.unshift(e.dottedName);const s=e.possibilities&&this.evaluateNode(e.possibilities);if(void 0!==s?.nodeValue)return{...e,...s.unit?{unit:s.unit}:{},nodeValue:s.nodeValue,missingVariables:L(s.missingVariables,a),possibilities:s};const l=this.evaluateNode(e.explanation.valeur);if(this.cache._meta.evaluationRuleStack.shift(),l.missingVariables??={},function(e,n,t){!0!==n.private&&ze(e.context.parsedRules,"",n.dottedName)&&(void 0!==t.nodeValue||Object.keys(t.missingVariables).length||(t.missingVariables[n.dottedName]=1))}(this,e,l),s&&this.context.strict.checkPossibleValues&&!ge(this,s,l))throw new n("EvaluationError",`La valeur "${l.nodeValue}" de la r√®gle ${e.dottedName} n'est pas une des possibilit√©s attendues`,{dottedName:e.dottedName});const u=s?.unit??l.unit,c=L(L(s?.missingVariables??{},l.missingVariables),a);return{...l,...u?{unit:u}:{},missingVariables:c,...e,possibilities:s,explanation:{parents:e.explanation.parents,valeur:l,nullableParent:i,ruleDisabledByItsParent:t}}}),en.nom="avec";var nn=(e,t)=>e.map((i,a)=>{if(!i.plafond&&a>e.length)throw new n("SyntaxError",`La tranche n¬∞${a} du bar√®me n'a pas de plafond pr√©cis√©. Seule la derni√®re tranche peut ne pas √™tre plafonn√©e`,{dottedName:""});return{...i,...void 0!==i.taux?{taux:kt(i.taux,t)}:{},...void 0!==i.montant?{montant:kt(i.montant,t)}:{},plafond:"plafond"in i?kt(i.plafond,t):{nodeValue:1/0,nodeKind:"constant",type:"number",isNullable:!1}}});function tn({multiplicateur:e,assiette:t,parsedTranches:i}){return i.reduce(([i,a],o,s)=>{if(a)return[[...i,{...o,isAfterActive:!0}],a];const l=this.evaluateNode(o.plafond),u=i[s-1]?i[s-1].plafond:{nodeValue:0};let c=void 0===l.nodeValue||void 0===e.nodeValue?void 0:l.nodeValue*e.nodeValue;try{c=c===1/0||0===c?c:oe(Q("*",[l.unit,e.unit]),t.unit,c)}catch(e){if(!(e instanceof Error))throw e;r(this.context,`L'unit√© du plafond de la tranche n¬∞${s+1}  n'est pas compatible avec celle l'assiette`,"unitConversion",e)}const d=i[s-1]?i[s-1].plafondValue:0,p=void 0===d||void 0===t.nodeValue?void 0:d>t.nodeValue,m=[l,t,e,u];if(m.some(e=>void 0===e.nodeValue))return[[...i,{...o,plafond:l,plafondValue:c,plancherValue:d,nodeValue:void 0,isActive:void 0,isAfterActive:p,missingVariables:T(m)}],!1];if(i[s-1]&&d&&c<=d)throw new n("EvaluationError",`Le plafond de la tranche n¬∞${s+1} a une valeur inf√©rieure √† celui de la tranche pr√©c√©dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]});const f={...o,plafond:l,plancherValue:d,plafondValue:c,isAfterActive:p,isActive:t.nodeValue>=d&&t.nodeValue<c};return[[...i,f],f.isActive]},[[],!1])[0]}function an(e,n){return{explanation:{si:kt(e.si,n),alors:kt(e.alors,n),sinon:kt(e.sinon,n)},nodeKind:"condition"}}function rn(e,n){const t=kt(e.valeur,n),i=Object.keys(e.contexte).map(t=>[kt(t,n),kt(e.contexte[t],n)]).sort(([e],[n])=>e.name.localeCompare(n.name));return{explanation:{valeur:t,contexte:i,subEngineId:function(e){let n=0;for(let t=0,i=e.length;t<i;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return n}(JSON.stringify(i))},nodeKind:rn.nom}}function on(e){let[n,t,i]=e.split("/");return i||([n,t,i]=["01",n,t]),ln(+i,+t,+n)}A("bar√®me",function(e){const t=this.evaluateNode.bind(this),i=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur);if(0===a.nodeValue)throw new n("EvaluationError","Le multiplicateur ne peut pas √™tre nul",{dottedName:this.cache._meta.evaluationRuleStack[0]});let r=e.explanation.tranches,o=i.nodeValue;return[0,void 0,null].includes(i.nodeValue)||(r=function(e,n,t){return e.map(e=>{if(e.isAfterActive)return{...e,nodeValue:0};const i=t(e.taux),a=T([i,e]);return[n.nodeValue,i.nodeValue,e.plafondValue,e.plancherValue].some(e=>void 0===e)?{...e,taux:i,nodeValue:void 0,missingVariables:a}:{...e,taux:i,..."unit"in n&&{unit:n.unit},nodeValue:(Math.min(n.nodeValue,e.plafondValue)-e.plancherValue)*oe(i.unit,J(""),i.nodeValue),missingVariables:a}})}(tn.call(this,{parsedTranches:e.explanation.tranches,assiette:i,multiplicateur:a}),i,t),o=r.reduce((e,{nodeValue:n})=>null==n?void 0:e+n,0)),{...e,nodeValue:o,missingVariables:T([i,a,...r]),explanation:{assiette:i,multiplicateur:a,tranches:r},unit:i.unit}}),an.nom="condition",A("condition",function(e){let t;const i=this.evaluateNode(e.explanation.si);let a=e.explanation.alors,r=e.explanation.sinon;if("unit"in i)throw new n("EvaluationError","La condition doit √™tre de type bool√©en",{dottedName:this.cache._meta.evaluationRuleStack[0]});if(!0===i.nodeValue)a=this.evaluateNode(e.explanation.alors),a.isActive=!0,t=a;else if(!1===i.nodeValue)r=this.evaluateNode(e.explanation.sinon),t=r;else if(null===i.nodeValue)t=i;else{if(void 0!==i.nodeValue)throw new n("EvaluationError","La condition doit √™tre de type bool√©en",{dottedName:this.cache._meta.evaluationRuleStack[0]});r=this.evaluateNode(e.explanation.sinon),a=this.evaluateNode(e.explanation.alors),t={...i,missingVariables:T([r,a])}}const o=t.unit??a.unit;return{nodeValue:t.nodeValue,missingVariables:L(K(i.missingVariables),t.missingVariables),...null!=o?{unit:o}:{},...e,explanation:{si:i,alors:a,sinon:r}}}),rn.nom="contexte",A("contexte",function(e){const t=[],i=Object.fromEntries(e.explanation.contexte.filter(([e,n])=>{const i=this.evaluateNode(e),a=this.evaluateNode(n);return void 0===a.nodeValue&&t.push(e.dottedName),i.nodeValue!==a.nodeValue||G(i.unit)!==G(a.unit)}).map(([e,n])=>[e.dottedName,n]));if(this.cache._meta.currentContexteSituation===JSON.stringify(i))return{...M,...e};let a;this.context.subEngines.has(e.explanation.subEngineId)?a=this.context.subEngines.get(e.explanation.subEngineId):(a=this.shallowCopy(),a.context.warn.experimentalRules=!1,a.context.subEngineId=e.explanation.subEngineId,this.context.subEngines.set(e.explanation.subEngineId,a),Object.keys(i).length&&(a.setSituation(i,{keepPreviousSituation:!0}),Object.entries(i).forEach(([e,t])=>{const i=this.cache.nodes.get(t);if(!i)throw new n("InternalError","The situation should have already been evaluated",{dottedName:this.context.dottedName});const r=a.context.parsedRules[e+" . $SITUATION"];if(!r?.explanation.valeur)throw new n("InternalError","The origin rule should be defined",{dottedName:this.context.dottedName});a.cache.nodes.set(r.explanation.valeur,i)}))),a.cache._meta.currentContexteSituation=JSON.stringify(i);const r=a.evaluateNode(e.explanation.valeur),o=e.explanation.contexte.map(([e])=>e.dottedName),s=o.filter(e=>t.includes(e)),l=Object.fromEntries(Object.entries(r.missingVariables).filter(([e])=>!o.includes(e)||s.includes(e)));return{...e,nodeValue:r.nodeValue,explanation:{...e.explanation,valeur:r},missingVariables:l,..."unit"in r&&{unit:r.unit}}});var sn=e=>+e<10?`0${e}`:""+e;function ln(e,t,i){const a=new Date(+e,+t-1,+i);if(!+a||a.getDate()!==+i)throw new n("SyntaxError",`La date ${i}/${t}/${e} n'est pas valide`,{dottedName:""});return`${sn(i)}/${sn(t)}/${sn(e)}`}function un(e){const[n,t,i]=on(e).split("/"),a=new Date(+i,+t-1,+n);return a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),a}function cn(e){return+e.slice(-4)}function dn(e){const[,n,t]=e.split("/");return`01/${(3*Math.floor((Number.parseInt(n,10)-1)/3)+1).toString().padStart(2,"0")}/${t}`}function pn(e,n){return(un(n).getTime()-un(e).getTime())/864e5}function mn(e,n){const[t,i,a]=e.split("/").map(e=>+e),[r,o,s]=n.split("/").map(e=>+e);return o-i+12*(s-a)-(t-1)/new Date(a,i,0).getDate()+r/new Date(s,o,0).getDate()}function fn(e,n){const t=pn(e,n),i=e=>e>=new Date(e.getFullYear(),2,1),a=un(e),r=un(n),o=a.getFullYear()+(i(a)?1:0),s=r.getFullYear()+(i(a)?0:-1);return(t-Array.from({length:s-o+1},(e,n)=>o+n).filter(e=>e%4==0&&e%100!=0||e%400==0).length)/365}var hn,vn=D(ln((hn=new Date).getFullYear(),hn.getMonth()+1,hn.getDate()));A("dur√©e",function(e){const n=this.evaluateNode(e.explanation.depuis),t=this.evaluateNode(e.explanation["jusqu'√†"]),i=n.nodeValue,a=t.nodeValue;let r;if(null===i||null===a)r=null;else if(void 0===i||void 0===a)r=void 0;else switch(e.unit.numerators[0]){case"jour":r=pn(i,a);break;case"mois":r=mn(i,a);break;case"an":r=fn(i,a);break;case"trimestre":r=mn(i,a)/3;break;case"trimestre civil":r=function(e,n){return Math.floor(mn(dn(e),dn(n))/3)+1}(i,a);break;case"ann√©e civile":r=function(e,n){const t="01/"+cn(e),i="01/"+cn(n);return Math.floor(fn(t,i))+1}(i,a)}return"number"==typeof r&&(r=Math.max(0,r)),{...e,missingVariables:T([n,t]),nodeValue:r,explanation:{depuis:n,"jusqu'√†":t}}});var bn=["mois","jour","an","trimestre","trimestre civil","ann√©e civile"];function gn(e,n){return{explanation:kt(e,n),nodeKind:"est non d√©fini"}}gn.nom="est non d√©fini";var xn=U("est d√©fini",{valeur:{}},{"=":[{"est non d√©fini":"valeur"},"non"]}),Nn=U("est applicable",{valeur:{}},{"=":[{"est non applicable":"valeur"},"non"]});function Vn(e,n,t,i=0,a=100,r=0){let o,s,l,u,c,d,p=n,m=t,f=p,h=e(p),v=e(m),b=h;for(;a-- >0;){if(l=m-p,Math.abs(b)<Math.abs(v)&&(p=m,m=f,f=p,h=v,v=b,b=h),o=1e-15*Math.abs(m)+i/2,s=(f-m)/2,Math.abs(s)<=o||0===v)return m;if(Math.abs(l)>=o&&Math.abs(h)>Math.abs(v)){let e,n;const t=f-m;p===f?(e=v/h,u=t*e,c=1-e):(c=h/b,e=v/b,n=v/h,u=n*(t*c*(c-e)-(m-p)*(e-1)),c=(c-1)*(e-1)*(n-1)),u>0?c=-c:u=-u,u<.75*t*c-Math.abs(o*c)/2&&u<Math.abs(l*c/2)&&(s=u/c)}if(Math.abs(s)<o&&(s=s>0?o:-o),p=m,h=v,m+=s,v=e(m),(v>0&&b>0||v<0&&b<0)&&(f=p,b=h),Math.abs(v)<i)return m;Math.abs(v)<r&&(d=m)}return d}A("est non d√©fini",function(e){const n=this.evaluateNode(e.explanation);let t=!1;return void 0===n.nodeValue&&(t=!0),{...e,nodeValue:t,missingVariables:n.missingVariables,explanation:n}}),A("grille",function(e){const t=this.evaluateNode.bind(this),i=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur);if(0===a.nodeValue)throw new n("EvaluationError","Le multiplicateur ne peut pas √™tre nul",{dottedName:this.cache._meta.evaluationRuleStack[0]});const r=tn.call(this,{parsedTranches:e.explanation.tranches,assiette:i,multiplicateur:a}).map(e=>{if(!1===e.isActive)return e;const n=t(e.montant);return{...e,montant:n,nodeValue:n.nodeValue,unit:n.unit,missingVariables:T([n,e])}});let o;const s=r.find(e=>e.isActive);o=s?[s]:!1===r[r.length-1].isAfterActive?[{nodeValue:!1}]:r.filter(e=>void 0===e.isActive);const l=!!o[0]&&(void 0===o[0].isActive?void 0:o[0].nodeValue);return{...e,nodeValue:l,missingVariables:T([i,a,...o]),explanation:{...e.explanation,assiette:i,multiplicateur:a,tranches:r},unit:o[0]?.unit??void 0}}),A("inversion",function(e){const n=this.shallowCopy();if(n.context.warn.experimentalRules=!1,this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToInverse))return{...C,...e};n.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],n.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];const t=e.explanation.inversionCandidates.find(e=>{if(this.cache._meta.evaluationRuleStack.includes(e.dottedName))return!1;const t=n.evaluateNode(n.context.parsedRules[`${e.dottedName} . $SITUATION`]);return"number"==typeof t.nodeValue&&!(e.dottedName in t.missingVariables)});if(void 0===t)return{...e,nodeValue:void 0,missingVariables:{...Object.fromEntries(e.explanation.inversionCandidates.map(e=>[e.dottedName,1])),[e.explanation.ruleToInverse]:1}};const i=n.evaluateNode(t);let a,r=0;n.setSituation({[t.dottedName]:C},{keepPreviousSituation:!0}),n.cache.traversedVariablesStack=this.cache.traversedVariablesStack?[]:void 0;const o=o=>(r++,n.setSituation({[e.explanation.ruleToInverse]:{nodeValue:o,nodeKind:"constant",type:"number",unit:i.unit}},{keepPreviousSituation:!0}),n.cache.traversedVariablesStack=this.cache.traversedVariablesStack?[]:void 0,a=n.evaluateNode(t),a),s=i.nodeValue;let l;const u=s,c=o(u).nodeValue,d=void 0!==c?u*s*(c>s?.9:1.2)/c:2e3,p=o(d).nodeValue,m=this.context.inversionMaxIterations??10;if(void 0===c&&void 0===p||(l=Vn(e=>(e===u?c:e===d?p:o(e).nodeValue)-s,void 0!==p&&p<s&&(p>c||c>s)?d:void 0!==c&&c<s&&(c>p||p>s)?u:e.explanation.min,void 0!==p&&p>s&&(p<c||c<s)?d:void 0!==c&&c>s&&(c<p||p<s)?u:e.explanation.max,e.explanation.errorTolerance,m,1),l&&(l<e.explanation.min||l>e.explanation.max)&&(l=void 0)),null==l&&(this.cache.inversionFail=!0),this.cache.traversedVariablesStack){const e=this.cache.traversedVariablesStack[0];e&&(a.traversedVariables??[]).forEach(n=>e.add(n))}return{...e,nodeValue:l,unit:i.unit,explanation:{...e.explanation,inversionGoal:t,numberOfIteration:r,inversionFail:this.cache.inversionFail},missingVariables:a.missingVariables}});var yn=q("le maximum de",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,n)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{">":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv√©] $INTERNAL valeur":{valeur:n},"[priv√©] $INTERNAL acc":{valeur:e}}}),M)),wn=q("le minimum de",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,n)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{"<":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv√©] $INTERNAL valeur":{valeur:n},"[priv√©] $INTERNAL acc":{valeur:e}}}),M));function En(e){return e.reverse().reduce((e,n)=>({"+":[n,e]}),M)}var Rn=q("somme",{valeur:{type:"liste"}},({valeur:e})=>En([...e])),Sn=q("moyenne",{valeur:{type:"liste"}},({valeur:e})=>{const n=[...e];return{"/":[En(n),En(n.map($n))]}});function $n(e){return{"applicable si":{"est applicable":e},valeur:1}}var In=U("non applicable si",{"non applicable si":{},valeur:{}},{condition:{si:"non applicable si = non",alors:"valeur",sinon:M}}),kn={"*":[(e,n)=>e*n,"√ó"],"/":[(e,n)=>e/n,"‚àï"],"//":[(e,n)=>(e-e%n)/n,"//"],"**":[(e,n)=>e**n,"**"],"+":[(e,n)=>e+n],"-":[(e,n)=>e-n,"‚àí"],"<":[(e,n)=>e<n],"<=":[(e,n)=>e<=n,"‚â§"],">":[(e,n)=>e>n],">=":[(e,n)=>e>=n,"‚â•"],"=":[(e,n)=>(e??!1)===(n??!1)],"!=":[(e,n)=>(e??!1)!==(n??!1),"‚â†"],et:[(e,n)=>(e??!1)&&(n??!1)],ou:[(e,n)=>(e??!1)||(n??!1)]},An=(e,n)=>(t,i)=>{const a=t.map(e=>kt(e,i));return{...t,nodeKind:"operation",operationKind:e,operator:n||e,explanation:a}};A("operation",function(e){let t=this.evaluateNode(e.explanation[0]),i={...e,missingVariables:{}};if(null===t.nodeValue&&["<",">","<=",">=","/","*","//","-","et"].includes(e.operationKind)||0===t.nodeValue&&["/","*"].includes(e.operationKind)||!1===t.nodeValue&&"et"===e.operationKind||!0===t.nodeValue&&"ou"===e.operationKind)return{...i,nodeValue:"et"!==e.operationKind&&t.nodeValue,missingVariables:t.missingVariables};let a=this.evaluateNode(e.explanation[1]);if(i.explanation=[t,a],"/"===e.operationKind&&0===a.nodeValue)throw new n("EvaluationError","Division by zero",{dottedName:this.cache._meta.evaluationRuleStack[0]});if(null===a.nodeValue&&["<",">","<=",">=","/","*","//","et"].includes(e.operationKind)||0===a.nodeValue&&["*"].includes(e.operationKind)||!1===a.nodeValue&&"et"===e.operationKind||!0===a.nodeValue&&"ou"===e.operationKind)return{...i,nodeValue:"et"!==e.operationKind&&a.nodeValue,missingVariables:a.missingVariables};i.missingVariables=T([t,a]),void 0!==t.nodeValue&&void 0!==a.nodeValue||(i={...i,nodeValue:void 0});const o=["+","-"].includes(e.operationKind)&&"%"===G(a.unit)&&"%"!==G(t.unit);if(!("nodeValue"in i)&&!["/","*","//"].includes(e.operationKind)&&!o)try{t.unit&&"unit"in a?a=be(t.unit,a):a.unit&&(t=be(a.unit,t))}catch(n){if(!(n instanceof Error))throw n;r(this.context,`Dans l'expression '${e.operationKind}', la partie gauche (unit√©: ${G(t.unit)}) n'est pas compatible avec la partie droite (unit√©: ${G(a.unit)})`,"unitConversion",n)}const s=kn[e.operationKind][0],l=t.nodeValue,u=a.nodeValue;if(i.nodeValue="nodeValue"in i?i.nodeValue:["<",">","<=",">=","*","/","//"].includes(e.operationKind)&&null===a.nodeValue?null:[l,u].every(e=>"string"==typeof e&&e.match?.(/^[\d]{2}\/[\d]{2}\/[\d]{4}$/))?s(un(l).getTime(),un(u).getTime()):s(l,u),"*"===e.operationKind&&Q("*",[t.unit,a.unit])?.numerators.includes("%")){const e=Q("*",[t.unit,a.unit]),n=i.nodeValue;return{...i,nodeValue:"number"==typeof n?n/100:n,unit:Q("*",[e,{numerators:[],denominators:["%"]}])}}if(o){const n=Q("*",[t.unit,a.unit]);return{...i,nodeValue:"number"==typeof t.nodeValue&&"number"==typeof a.nodeValue?t.nodeValue*(1+a.nodeValue/100*("-"===e.operationKind?-1:1)):i.nodeValue,unit:Q("*",[n,{numerators:[],denominators:["%"]}])}}return"*"===e.operationKind||"/"===e.operationKind||"//"===e.operationKind||"-"===e.operationKind||"+"===e.operationKind?{...i,unit:Q(e.operationKind,[t.unit,a.unit])}:i});var _n=Object.fromEntries(Object.entries(kn).map(([e,[,n]])=>[e,An(e,n)])),jn=U("par d√©faut",{"par d√©faut":{},valeur:{}},{condition:{si:{"est non d√©fini":"valeur"},alors:"par d√©faut",sinon:"valeur"}}),On=U("plafond",{plafond:{},valeur:{}},{condition:{si:{et:["plafond != non","valeur > plafond"]},alors:"plafond",sinon:"valeur"}}),Kn=U("plancher",{plancher:{},valeur:{}},{condition:{si:{et:["plancher != non","valeur < plancher"]},alors:"plancher",sinon:"valeur"}}),Ln=q("produit",{valeur:{type:"liste"}},({valeur:e})=>{return{valeur:(n=[...e],n.reduce((e,n)=>({"*":[n,e]}),D(1))),"simplifier l'unit√©":"oui"};var n});function Tn(e,n){return{explanation:{ruleToSolve:n.dottedName,valeur:kt(e.valeur,n)},nodeKind:"r√©soudre r√©f√©rence circulaire"}}function Dn(e,n){return{explanation:kt(e.valeur,n),nodeKind:"simplifier unit√©"}}Tn.nom="r√©soudre la r√©f√©rence circulaire",A("r√©soudre r√©f√©rence circulaire",function(e){if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToSolve))return{...C,...e};let n=0;const t=this.shallowCopy();t.context.warn.experimentalRules=!1,t.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],t.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];const i=this.context.inversionMaxIterations??25,a=i=>(n++,t.setSituation({[e.explanation.ruleToSolve]:{...C,nodeValue:i}},{keepPreviousSituation:!0}),t.evaluateNode(e.explanation.valeur)),r=Symbol("inversion failed");let o=r,s=a(1);const l=s.nodeValue,u=s.unit;return void 0!==l&&(o=Vn(e=>1===e?l-1:(s=a(e),s.nodeValue-e),-1e6,1e8,.5,i,2)),o===r&&(o=void 0,this.cache.inversionFail=!0),void 0!==o&&(s=a(o)),{...e,unit:u,nodeValue:o,explanation:{...e.explanation,valeur:s,numberOfIterations:n},missingVariables:s.missingVariables}}),Dn.nom="simplifier l'unit√©",A("simplifier unit√©",function(e){const n=this.evaluateNode(e.explanation),t=n.nodeValue,i={...n,...e,explanation:n};if(null==t)return i;if(!n.unit)return{...i,unit:n.unit};const a=de(n.unit);return{...i,nodeValue:"number"==typeof t?oe(n.unit,a,t):t,unit:a}});var Mn=U("dans la situation",{valeur:{},"dans la situation":{}},{condition:{si:{"est non d√©fini":"dans la situation"},alors:"valeur",sinon:"dans la situation"}});A("taux progressif",function(e){const t=this.evaluateNode.bind(this),i=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur);if(0===a.nodeValue)throw new n("EvaluationError","Division by zero",{dottedName:""});const r=tn.call(this,{parsedTranches:e.explanation.tranches,assiette:i,multiplicateur:a}),o={...e,explanation:{tranches:r,assiette:i,multiplicateur:a},unit:J("%")},s=r[r.length-1];if(r.every(({isActive:e})=>!1===e)||s.isActive&&s.plafond.nodeValue===1/0){const e=be(J("%"),t(s.taux)),{nodeValue:n,missingVariables:i}=e;return s.taux=e,s.nodeValue=n,s.missingVariables=i,{...o,nodeValue:n,missingVariables:i}}if(r.every(({isActive:e})=>!0!==e)||"number"!=typeof i.nodeValue)return{...o,nodeValue:void 0,missingVariables:T(r)};const l=r.findIndex(({isActive:e})=>!0===e),u=r[l];u.taux=be(J("%"),t(u.taux));const c=r[l-1];c&&(c.taux=be(J("%"),t(c.taux)),c.isActive=!0);const d=c?c.taux:u.taux,p=[d,u.taux];if(p.some(e=>void 0===e.nodeValue))return u.nodeValue=void 0,{...o,nodeValue:void 0,missingVariables:T(p)};const m=d.nodeValue,f=u.taux.nodeValue,h=u.plancherValue,v=(f-m)/(u.plafondValue-h),b=m+(i.nodeValue-h)*v;return u.nodeValue=b,{...o,nodeValue:b,missingVariables:{}}});var Pn="texte";function Cn(e,n){const t=[];let i=0;for(const{0:a,index:r}of e.matchAll(/{{(.|\n)*?}}/g)){const o=kt(a.slice(2,-2).trim(),n);t.push(e.substring(i,r),o),i=(r??0)+a.length}return t.push(e.slice(i)),{nodeKind:Pn,explanation:t}}Cn.nom=Pn,A(Pn,function(e){const n=e.explanation.map(e=>"string"==typeof e?e:this.evaluateNode(e));return{...e,explanation:n,missingVariables:T(n.filter(e=>"string"!=typeof e)),nodeValue:n.map(e=>"string"==typeof e?e:function(e,{language:n="fr",displayedUnit:t,formatUnit:i,precision:a=2}={}){let r="number"==typeof e||null==e?e:e.nodeValue;if("number"==typeof r&&Number.isNaN(r))return"Erreur dans le calcul du nombre";if(void 0===r)return"Pas encore d√©fini";if(null===r)return"Non applicable";if("string"==typeof r)return r.replace("\\n","\n");if("boolean"==typeof r)return Ne[n][r];if("number"==typeof r){let o="number"!=typeof e&&void 0!==e&&"unit"in e?e.unit:void 0;if(o){const e=de(o);r=oe(o,e,r),o=e}return function({maximumFractionDigits:e,minimumFractionDigits:n,language:t,formatUnit:i,unit:a,nodeValue:r}){if("number"!=typeof r)return r;const o=a?G(a,r,i):void 0;switch(o){case"‚Ç¨":return xe({style:"currency",maximumFractionDigits:e,minimumFractionDigits:n,language:t})(r);case"%":return xe({style:"percent",maximumFractionDigits:e,language:t})(r/100);default:return xe({style:"decimal",minimumFractionDigits:n,maximumFractionDigits:e,language:t})(r)+("string"==typeof o?`¬†${o}`:"")}}({minimumFractionDigits:0,maximumFractionDigits:a,language:n,formatUnit:i,nodeValue:r,unit:t??o}).trim()}}(e)).join("")}});var Un=q("toutes ces conditions",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,n)=>({et:[e,n]}),"oui")),qn=q("une de ces conditions",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,n)=>({ou:[e,n]}),"non"));function Fn(e,n){return{explanation:kt(e.valeur,n),unit:J(e.unit√©,n.getUnitKey),nodeKind:Fn.nom}}function zn(e,n){return{missingVariable:e["variable manquante"],nodeKind:zn.nom,explanation:kt(e.valeur,n)}}Fn.nom="unit√©",A(Fn.nom,function(e){const n=this.evaluateNode(e.explanation);let t=n.nodeValue;if(null!==t&&"unit"in e)try{t=oe(n.unit,e.unit,n.nodeValue)}catch(e){if(!(e instanceof Error))throw e;r(this.context,"Erreur lors de la conversion d'unit√© explicite","unitConversion",e)}return{...e,nodeValue:t,explanation:n,missingVariables:n.missingVariables}}),zn.nom="variable manquante",A(zn.nom,function(e){const n=this.evaluateNode(e.explanation),t=Object.values(n.missingVariables??{}).reduce((e,n)=>e>n?e:n,0);return{...e,nodeValue:n.nodeValue,unit:n.unit,explanation:n,missingVariables:L(n.missingVariables,{[e.missingVariable]:t+1})}}),A("variations",function(e){const[n,t,i]=e.explanation.reduce(([e,n,t,i],{condition:a,consequence:o},s)=>{if(!0===i)return[e,[...n,{condition:a,consequence:o}],t,i];const l=this.evaluateNode(a),u=void 0===i?i:!i&&(void 0===l.nodeValue?void 0:!1!==l.nodeValue&&null!==l.nodeValue);if(!1===u||null===u)return[e,[...n,{condition:l,consequence:o}],t,i];let c;if(!1!==l.nodeValue&&null!==l.nodeValue&&(c=this.evaluateNode(o),t))try{c=be(t,c)}catch(e){if(!(e instanceof Error))throw e;r(this.context,`L'unit√© de la branche n¬∞ ${s+1} du m√©canisme 'variations' n'est pas compatible avec celle d'une branche pr√©c√©dente`,"unitConversion",e)}return[u&&c?.nodeValue,[...n,{condition:l,consequence:c??o}],t||c?.unit,i||u]},[null,[],void 0,!1]);return{...e,nodeValue:n,...void 0!==i&&{unit:i},explanation:t,missingVariables:t.reduce((e,{condition:n,consequence:t})=>L(e,L(K(n.missingVariables),"nodeValue"in n&&!1!==n.nodeValue&&null!==n.nodeValue?t.missingVariables:{})),{})}});var Bn=class extends Error{details;constructor(e){super(Wn(e)),this.details=e}},Jn=class extends n{constructor(e){super("SyntaxError",Wn(e),e)}};function Wn({expression:e,position:n,expected:t,found:i,customMessage:a}){return`L'expression suivante n'est pas valide :\n   \n   ${e}\n   ${" ".repeat(n)+"^"}\n   ${a??`${t} est attendu, ${i?`mais "${i}" a √©t√© trouv√©`:"hors l‚Äôexpression se termine pr√©matur√©ment"}`}\n`}function Yn(e,n,t,i){throw new Bn({expression:e.strExpression,position:e.current,expected:n,found:t,customMessage:i})}function Zn(e,n){return ot(e)&&Yn(e,`'${n}'`,""),e.strExpression[e.current++]}function Gn(e,n,t,i){const a=e.strExpression.slice(e.current).match(n);return a||Yn(e,t??n.source,tt(e,5),i),e.current+=a[0].length,{parser:e,value:a[0]}}function Hn(e){let n=Qn(e);for(;!ot(n)&&at(n,$t);){const e=rt(n,$t),t=Qn(e.parser);t.tree=ut(e.value,n.tree,t.tree),n=t}return n}function Qn(e){let n=Xn(e);for(;!ot(n)&&at(n,St);){const e=rt(n,St),t=Xn(e.parser);t.tree=ut(e.value,n.tree,t.tree),n=t}return n}function Xn(e){let n=et(e);for(;!ot(n)&&at(n,Rt);){const e=rt(n,Rt),t=et(e.parser);t.tree=ut(e.value,n.tree,t.tree),n=t}return n}function et(e){let n=nt(e);for(;!ot(n)&&at(n,Et);){const e=rt(n,Et),t=et(e.parser);t.tree=ut(e.value,n.tree,t.tree),n=t}return n}function nt(e){if("("===tt(e)){Zn(e,"("),Gn(e,dt);const n=Hn(e);return Gn(n,dt),function(e){const n=tt(e);")"!==n&&Yn(e,"')'",n),Zn(e,")")}(n),n}if("-"===tt(e)){Zn(e,"-"),Gn(e,dt);const n=nt(e);return n.tree=function(e){return{"-":[{constant:{type:"number",nodeValue:0}},e]}}(n.tree),n}if(at(e,ht)){const t=Gn(e,ht,"Une date");return{...t.parser,tree:(n=t.value,{constant:{type:"date",nodeValue:on(n)}})}}if(tt(e).match(ft)){const n=Gn(e,ft,"Un nombre");if(at(n.parser,yt)){const e=Gn(n.parser,yt,"Une unit√©");return{...e.parser,tree:{constant:{type:"number",nodeValue:parseFloat(n.value),rawUnit:e.value.trim()}}}}return{...n.parser,tree:st(parseFloat(n.value))}}if(it(e,"'")||it(e,'"')){const n=Gn(e,mt,"Une cha√Æne de caract√®res");return{...n.parser,tree:{constant:{type:"string",nodeValue:n.value.slice(1,-1)}}}}if(tt(e).match(pt)||"^"===tt(e)){const n=Gn(e,Nt,"Un nom de r√®gle");return{...n.parser,tree:"oui"===n.value||"non"===n.value?lt(n.value):{variable:n.value}}}var n;Yn(e,"Une constante, une r√©f√©rence ou une expression entre parenth√®ses",tt(e))}function tt(e,n){return n?e.strExpression.slice(e.current,e.current+n):e.strExpression[e.current]}function it(e,n){return e.strExpression.slice(e.current,e.current+n.length)===n}function at(e,n){return null!=e.strExpression.slice(e.current).match(n)}function rt(e,n){const t=e.strExpression.slice(e.current).match(n);if(!t)throw new Error(`Expected '${n.source}' but got ${tt(e)}`);return e.current+=t[0].length,{parser:e,value:t[1]}}function ot(e){return e.current>=e.strExpression.length}function st(e){return{constant:{type:"number",nodeValue:e}}}function lt(e){return{constant:{type:"boolean",nodeValue:"oui"===e}}}function ut(e,n,t){return{[e]:[n,t]}}var ct=/[\t\u0020\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]/,dt=new RegExp(`^${ct.source}*`),pt=/[a-zA-Z\u00C0-\u017F$]/,mt=/'.*'|".*"/,ft=/\d+(\.\d+)?/,ht=/^(?:(?:0?[1-9]|[12][0-9]|3[01])\/)?(?:0?[1-9]|1[012])\/\d{4}/,vt=new RegExp(`(${pt.source}|${/[',¬∞‚Ç¨$%¬≤_'"'¬´¬ª]/.source}|${/\d/.source})`),bt=new RegExp(`(${vt.source}|\\-|\\+|')`),gt=e=>new RegExp(`(${e.source}${bt.source}*)(${ct.source}${vt.source}${bt.source}*)*`),xt=gt(pt),Nt=new RegExp(`^(${xt.source}|\\^)( \\. ${xt.source})*`),Vt=gt(new RegExp(`(${/[¬∞%\p{Sc}‚Ç¨$]/u.source}|${pt.source})`)),yt=new RegExp(`${dt.source}(\\/)?${Vt.source}(${ct.source}*(\\.|\\/)${Vt.source})*`),wt=e=>new RegExp(`^${ct.source}+(${e.join("|")})${ct.source}+`),Et=wt(["\\*\\*"]),Rt=wt(["\\*","\\/","\\/\\/"]),St=wt(["-","\\+"]),$t=wt([">","<",">=","<=","=","!="]),It=/(\+|-|\*|\/|\*\*|>|<|>=|<=|=|!=)/;function kt(e,t){if(null==e)throw new n("SyntaxError","\n\tUne des valeurs de la formule est vide.\n\tV√©rifiez que tous les champs √† droite des deux points sont remplis",{dottedName:t.dottedName});if("boolean"==typeof e)throw new n("SyntaxError","\nLes valeurs bool√©ennes true / false ne sont accept√©es.\nUtilisez leur contrepartie fran√ßaise : 'oui' / 'non'",{dottedName:t.dottedName});const i="object"==typeof e?e:function(e,n="<expression>"){if("number"==typeof e)return st(e);const t=(e+"").replace(/\s*\n\s*/g," ").trim();try{const e=Hn({strExpression:t,current:0,tree:null});return ot(e)||(at(e,It)&&Yn(e,"un op√©rateur entour√© d‚Äôespaces",tt(e),'Les op√©rateurs doivent √™tre entour√©s d‚Äôespaces ("2 + 2" et non "2+2")'),Yn(e,"La fin d‚Äôexpression",tt(e))),e.tree}catch(e){if(e instanceof Bn)throw new Jn({...e.details,dottedName:n});throw e}}(e,t.dottedName);return"nodeKind"in i?i:{...jt(i,t),rawNode:e}}function At(e,t){if(Array.isArray(e))throw new n("SyntaxError",`\nIl manque le nom du m√©canisme pour le tableau : [${e.map(e=>`'${e}'`).join(", ")}]\nLes m√©canisme possibles sont : 'somme', 'le maximum de', 'le minimum de', 'toutes ces conditions', 'une de ces conditions'.\n\t\t`,{dottedName:t.dottedName});const i=Object.keys(e);if(i.length>1)throw new n("SyntaxError",`\nLes m√©canismes suivants se situent au m√™me niveau : ${i.map(e=>`'${e}'`).join(", ")}\nCela vient probablement d'une erreur dans l'indentation\n\t`,{dottedName:t.dottedName});if(0===i.length)return{nodeKind:"constant",nodeValue:void 0};const a=i[0],r=e[a],o=Ot[a];if(!o)throw new n("SyntaxError",`Le m√©canisme "${a}" est inconnu.\n\nV√©rifiez qu'il n'y ait pas d'erreur dans l'orthographe du nom.`,{dottedName:t.dottedName});try{return o(r,t)}catch(e){if(e instanceof n||!(e instanceof Error))throw e;throw new n("SyntaxError",a?`‚û°Ô∏è Dans le m√©canisme ${a}\n${e.message}`:e.message,{dottedName:t.dottedName})}}A("reference",function(e){if(!e.dottedName)throw new i(e);const n=this.evaluateNode(this.context.parsedRules[e.dottedName]);return delete n.sourceMap,{...n,...e}});var _t=[rn,zn,en,B,In,he,Fn,Dn,Kn,On,jn,Mn,Tn,z];function jt(e,n){const t=_t.find(n=>n.nom in e);if(!t)return At(e,n);const{[t.nom]:i,...a}=e;return At({[t.nom]:{valeur:a,[t.nom]:i}},n)}var Ot={..._n,..._t.reduce((e,n)=>({[n.nom]:n,...e}),{}),logarithme:function(e,n){return{explanation:kt(e,n),nodeKind:"logarithme"}},"inversion num√©rique":(e,t)=>{let i="object"==typeof e&&"avec"in e?e.avec:e;const a="object"==typeof e&&"min"in e?e.min:-1e6,r="object"==typeof e&&"max"in e?e.max:1e8,o="object"==typeof e&&"tol√©rance d'erreur"in e?e["tol√©rance d'erreur"]:.1;if(null===e)throw new n("SyntaxError","Il manque les r√®gles avec laquelle effectuer le calcul d'inversion dans le m√©canisme `inversion num√©rique`",{dottedName:t.dottedName});return Array.isArray(i)||(i=[i]),{explanation:{ruleToInverse:t.dottedName,inversionCandidates:i.map(e=>({...kt(e,t)})),min:a,max:r,errorTolerance:o},nodeKind:"inversion"}},"le maximum de":yn,"le minimum de":wn,"taux progressif":function(e,n){return{explanation:{assiette:kt(e.assiette,n),multiplicateur:e.multiplicateur?kt(e.multiplicateur,n):D(1),tranches:nn(e.tranches,n)},nodeKind:"taux progressif"}},"toutes ces conditions":Un,"est non d√©fini":gn,"est non applicable":Ve,"est applicable":Nn,"est d√©fini":xn,"une de ces conditions":qn,condition:an,bar√®me:function(e,n){return{explanation:{assiette:kt(e.assiette,n),multiplicateur:e.multiplicateur?kt(e.multiplicateur,n):D(1),tranches:nn(e.tranches,n)},nodeKind:"bar√®me"}},dur√©e:(e,t)=>{const i={depuis:kt(e.depuis??vn,t),"jusqu'√†":kt(e["jusqu'√†"]??vn,t)},a=e.unit√©?J(e.unit√©):J("jour");if(a.denominators.length>0||a.numerators.length>1||!bn.includes(a.numerators[0]))throw new n("SyntaxError",`Seules les unit√©s suivantes sont accept√©es pour une dur√©e : ${bn.join(", ")}.\n\tL'unit√© fournie est: ${a.numerators[0]}`,{dottedName:t.dottedName});return{explanation:i,unit:a,nodeKind:"dur√©e"}},grille:function(e,n){return{explanation:{assiette:kt(e.assiette,n),multiplicateur:e.multiplicateur?kt(e.multiplicateur,n):D(1),tranches:nn(e.tranches,n)},nodeKind:"grille"}},multiplication:Ln,produit:Ln,somme:Rn,moyenne:Sn,[Cn.nom]:Cn,valeur:kt,variable:function(e,t){if(!t.dottedName)throw new n("InternalError","Une r√©f√©rence ne peut pas exister en dehors d'une r√®gle (`context.dottedName` est vide)",{dottedName:e});if(!e)throw new n("SyntaxError","Une r√©f√©rence ne peut pas √™tre vide",{dottedName:t.dottedName});return{nodeKind:"reference",name:e,contextDottedName:t.dottedName}},variations:function(e,n){return{explanation:e.map(({si:e,alors:t,sinon:i})=>void 0!==i?{consequence:kt(i,n),condition:D(!0)}:{consequence:kt(t,n),condition:kt(e,n)}),nodeKind:"variations"}},constant:(e,n)=>Object.assign(e,{fullPrecision:!0,isNullable:null==e.nodeValue,missingVariables:{},nodeKind:"constant",dottedName:n.dottedName,..."number"===e.type&&e.rawUnit?{unit:J(e.rawUnit,n.getUnitKey)}:{}})},Kt=Object.keys(Ot),Lt=(Kt.filter(e=>!_t.find(({nom:n})=>n===e)),0),Tt={};function Dt(e,t){return e?(Array.isArray(e)?e:[e]).map(e=>{"string"==typeof e&&(e={"r√©f√©rences √†":e});const i=kt(e["r√©f√©rences √†"],t),[a,r]=[e.dans??[],e["sauf dans"]??[]].map(e=>Array.isArray(e)?e:[e]).map(e=>e.map(e=>kt(e,t)));if(null!=e.priorit√©&&("number"!=typeof e.priorit√©||e.priorit√©<0))throw new n("SyntaxError","La priorit√© du remplacement doit √™tre un nombre positif",t);return{nodeKind:"replacementRule",rawNode:e,priority:e.priorit√©,definitionRule:kt(t.dottedName,t),replacedReference:i,replaceByNonApplicable:!1,whiteListedNames:a,blackListedNames:r,remplacementRuleId:Lt++}}):[]}function Mt(e,n){const t=Dt(e,n);return t.forEach(e=>e.replaceByNonApplicable=!0),t}function Pt(e,n){return u((t,a)=>{if("replacementRule"===t.nodeKind||"inversion"===t.nodeKind||"une possibilit√©"===t.nodeKind)return!1;if("contexte"===t.nodeKind)return{...t,explanation:{...t.explanation,valeur:a(t.explanation.valeur),contexte:t.explanation.contexte.map(([e,n])=>[e,a(n)])}};if("reference"===t.nodeKind){if(!t.dottedName)throw new i(t);const a=function(e,n){const t=n.filter(({definitionRule:n})=>n.dottedName!==e.contextDottedName).filter(({whiteListedNames:n})=>!n.length||n.some(n=>e.contextDottedName.startsWith(n.dottedName))).filter(({blackListedNames:n})=>!n.length||n.every(n=>!e.contextDottedName.startsWith(n.dottedName))).reverse().sort((e,n)=>{const t=(n.priority??0)-(e.priority??0);return 0!==t?t:n.definitionRule.dottedName.localeCompare(e.definitionRule.dottedName)});if(!t.length)return e;const i=t.map(e=>e.remplacementRuleId).join("-");if(Tt[i])return Tt[i];const a={nodeKind:"variations",explanation:[...t.map(({definitionRule:e,replaceByNonApplicable:n})=>n?{condition:e,consequence:M}:{condition:Ct(e),consequence:e}),{condition:Ut,consequence:e}]};return a.sourceMap={mecanismName:"replacement",args:{applicableReplacements:t,originalNode:e}},Tt[i]=a,Tt[i]}(t,e[t.dottedName]??[]);return c(e=>(Ze(e,n,t.contextDottedName),"continue"))(a),a}})}function Ct(e){return{nodeKind:"condition",explanation:{si:{nodeKind:"est non applicable",explanation:e},alors:qt,sinon:Ut}}}var Ut=D(!0),qt=D(!1);function Ft(e){return{evaluatedRule:void 0,dottedName:"",logger:console,getUnitKey:e=>e,parsedRules:{},referencesMaps:{referencesIn:new Map,rulesThatUse:new Map},nodesTypes:new WeakMap,rulesReplacements:{},subEngines:new Map,subEngineId:void 0,...e,flag:{filterNotApplicablePossibilities:!1,automaticNamespaceDisabling:!0,...e.flag},strict:{situation:!0,noOrphanRule:!0,noCycleRuntime:!1,checkPossibleValues:!1,...e.strict},warn:{cyclicReferences:!0,experimentalRules:!0,unitConversion:!0,deprecatedSyntax:!0,situationIssues:!0,...e.warn}}}function zt(e){return Object.assign({},e,{parsedRules:l(e.parsedRules),referencesMaps:{referencesIn:new Map(e.referencesMaps.referencesIn),rulesThatUse:new Map(e.referencesMaps.rulesThatUse)},subEngines:new Map,warn:l(e.warn),strict:l(e.strict),flag:l(e.flag)})}function Bt(e,t=Ft({})){if("string"==typeof e)throw new n("EngineError","Publicodes does not parse yaml rule sets itself anymore. Please provide a parsed js object. E.g. the `eemeli/yaml` package.",{});const a=l(e),r=Ft(t),o=r.parsedRules;r.parsedRules={},Qe(a,r);let s={};for(const e in o)s[e]=o[e];for(const e in r.parsedRules)s[e]=r.parsedRules[e];const[c,d]=function(e,t,i,a){const r=u(n=>Ge(n,e)),o=u(n=>{const t=Ge(n,e);return t&&Ze(t,i),t}),s=function(e,n){const t={};for(const i in n)t[i]=e(n[i]);return t}(t=>{if("replacementRule"===t.nodeKind)return r(t);if("rule"===t.nodeKind){const i=t.explanation.parents.find(n=>!(n.dottedName in e));if(!a&&i)throw new n("SyntaxError",`La r√®gle parente "${i.dottedName}" n'existe pas`,{dottedName:t.dottedName})}return o(t)},t);return[s,i]}(s,r.parsedRules,r.referencesMaps,!r.strict.noOrphanRule);let p;return[s,p]=function({newRules:e,previousReplacements:n,parsedRules:t,referencesMaps:a}){const r=function(e){const n={};for(const t in e){const a=e[t];for(const e of a.replacements){if(!e.replacedReference.dottedName)throw new i(e);const t=e.replacedReference.dottedName;n[t]=[...n[t]??[],e]}}return n}(e),o=new Set([]);for(const e in r){const n=a.rulesThatUse.get(e)??[];for(const e of n)o.add(e)}const s=new Set(Object.keys(e).filter(e=>[...a.referencesIn.get(e)??new Set].some(e=>(n[e]??[]).length))),l=(u=n,c=r,Object.entries(c).reduce((e,[n,t])=>({...e,[n]:[...e[n]??[],...t]}),u));var u,c;if(!s.size&&!o.size)return[t,l];const d=Pt(n,a),p=Pt(r,a);return s.forEach(e=>{t[e]=d(t[e])}),o.forEach(e=>{t[e]=p(t[e])}),[t,l]}({parsedRules:s,newRules:c,referencesMaps:d,previousReplacements:r.rulesReplacements}),{parsedRules:s,nodesTypes:j(Object.keys(c),s,r.nodesTypes),referencesMaps:d,rulesReplacements:p}}var Jt=()=>({_meta:{evaluationRuleStack:[],parentRuleStack:[]},traversedVariablesStack:void 0,nodes:new Map}),Wt=class e{baseContext;context;publicParsedRules;publicSituation;cache=Jt();constructor(e={},n={}){const t=n.strict,i=n.warn,a={dottedName:"",...n,flag:{filterNotApplicablePossibilities:n.flag?.filterNotApplicablePossibilities??!1,automaticNamespaceDisabling:n.flag?.automaticNamespaceDisabling??!0},strict:"boolean"==typeof t?{situation:t,noOrphanRule:!0!==n.allowOrphanRules&&t,checkPossibleValues:t,noCycleRuntime:t}:"object"==typeof t?t:{},warn:"boolean"==typeof i?{cyclicReferences:i,experimentalRules:i,unitConversion:i}:"object"==typeof i?i:{}};this.baseContext=Ft({...a,...Bt(e,a)}),this.context=zt(this.baseContext),this.publicParsedRules={};for(const e in this.baseContext.parsedRules){const n=this.baseContext.parsedRules[e];!n.private&&ze(this.baseContext.parsedRules,"",e)&&(this.publicParsedRules[e]=n)}this.publicSituation={}}resetCache(){this.cache=Jt(),this.context.subEngines=new Map}setSituation(e={},n={}){this.resetCache();const t=n.keepPreviousSituation??!1,i=n.strict||this.baseContext.strict.situation;let a=Object.entries(e).filter(([e,n])=>{const t=this.checkSituationRule(e,n);if(!t)return!0;if(i||this.baseContext.strict.checkPossibleValues)throw t;return r(this.context,t.message,"situationIssues"),!1});const s=this.context;if(t||(this.context=zt(this.baseContext),this.publicSituation={}),i){const e=this.parseSituationRules(a);if(e)throw this.context=s,e}else a=a.filter(e=>{const n=this.parseSituationRules([e]);return n&&r(this.context,n.message,"situationIssues"),!n});return this.publicSituation=Object.assign(this.publicSituation,Object.fromEntries(a)),this.context.warn.experimentalRules&&Object.keys(this.publicSituation).forEach(e=>{Be(this.context.parsedRules,e)&&o(this.context,e),this.checkExperimentalRule(this.context.parsedRules[`${e} . $SITUATION`])}),this}inversionFail(){return!!this.cache.inversionFail}getRule(e){if(!(e in this.baseContext.parsedRules))throw new n("UnknownRule",`La r√®gle '${e}' n'existe pas`,{dottedName:e});if(!(e in this.publicParsedRules))throw new n("PrivateRule",`La r√®gle ${e} est une r√®gle priv√©e.`,{dottedName:e});return this.publicParsedRules[e]}getParsedRules(){return this.publicParsedRules}getSituation(){return this.publicSituation}getPossibilitiesFor(e,{filterNotApplicable:t=!1}={}){if(!this.context.flag?.filterNotApplicablePossibilities&&t)throw new n("EngineError","You must enable `flag.filterNotApplicablePossibilities` in engine instantiation to use the filterNotApplicable option",{});const i=this.getRule(e);return i.possibilities?t?this.evaluateNode(i.possibilities).explanation.filter(e=>!0!==e.notApplicable?.nodeValue):i.possibilities.explanation:null}evaluate(e){const n=this.cache.nodes.get(e);if(n)return n;this.context=Object.assign(this.context,Bt({"[priv√©] $EVALUATION":e&&"object"==typeof e&&"nodeKind"in e?{valeur:e}:e},this.context)),this.checkExperimentalRule(this.context.parsedRules.$EVALUATION),this.cache._meta=Jt()._meta;const t=this.evaluateNode(this.context.parsedRules.$EVALUATION.explanation.valeur);return this.cache.nodes.set(e,t),t}evaluateNode(e){const t=this.cache.nodes.get(e);let i=!1;if(this.cache.traversedVariablesStack&&(i=function(e,n){return!!e&&(0===e.length||"rule"===n.nodeKind)}(this.cache.traversedVariablesStack,e),function(e,n,t,i,a){void 0!==e&&(void 0===t?(a&&e.unshift(new Set),"reference"===n.nodeKind&&n.dottedName&&n.dottedName in i&&e[0].add(n.dottedName)):t.traversedVariables?.forEach(n=>e[0]?.add(n)))}(this.cache.traversedVariablesStack,e,t,this.publicParsedRules,i)),void 0!==t)return t;if(!k[e.nodeKind])throw new n("EvaluationError",`Unknown "nodeKind": ${e.nodeKind}`,{dottedName:""});const a=k[e.nodeKind].call(this,e);return this.cache.traversedVariablesStack&&function(e,n,t){void 0!==e&&t&&(n.traversedVariables=Array.from(e.shift()??[]),e.length>0&&n.traversedVariables.forEach(n=>{e[0].add(n)}))}(this.cache.traversedVariablesStack,a,i),this.cache.nodes.set(e,a),a}shallowCopy(){const n=new e;return n.baseContext=zt(this.baseContext),n.context=zt(this.context),n.publicParsedRules=this.publicParsedRules,n.publicSituation=l(this.publicSituation),n.cache={...Jt(),nodes:new Map(this.cache.nodes)},n}checkExperimentalRule=c(e=>("reference"===e.nodeKind&&Be(this.context.parsedRules,e.dottedName)&&o(this.baseContext,e.dottedName),"continue"));checkSituationRule(e,t){if(!(e in this.baseContext.parsedRules))return new n("SituationError",`'${e}' n'existe pas dans la base de r√®gle.`,{dottedName:e});const i=this.baseContext.parsedRules[e];if(i.private)return new n("SituationError",`La r√®gle ${e} est une r√®gle priv√©e.`,{dottedName:e});if(i.possibilities&&!ge(this,i.possibilities,this.evaluate(t))){const i=`La valeur "${this.evaluate(t).nodeValue}" ne fait pas partie des possibilit√©s applicables list√©es pour cette r√®gle.`;return new n("SituationError",i,{dottedName:e})}return!1}parseSituationRules(e){const t=Object.fromEntries(e.map(([e,n])=>[`[priv√©] ${e} . $SITUATION`,n&&"object"==typeof n&&"nodeKind"in n?{valeur:n}:n]));try{const e=Bt(t,this.context);return this.context=Object.assign(this.context,e),!1}catch(e){let t,i="";if(!(e instanceof Error))throw e;return i=e.message,"dottedName"in e&&(t=e.dottedName),new n("SituationError",i,{dottedName:t??""})}}};let Yt=null;globalThis.initEngine=e=>{try{console.log("JS: Initialisation du moteur...");const n=JSON.parse(e);return Yt=new Wt(n,{logger:{log:e=>{},warn:e=>{},error:e=>console.error(e)}}),JSON.stringify({status:"success"})}catch(e){return JSON.stringify({status:"error",message:e.message})}},globalThis.updateSituation=e=>{if(!Yt)return JSON.stringify({status:"error",message:"Engine not initialized"});try{const n=JSON.parse(e),t={};return Object.keys(n).forEach(e=>{null!==n[e]&&void 0!==n[e]&&(t[e]=n[e])}),Yt.setSituation(t),JSON.stringify({status:"updated"})}catch(e){return JSON.stringify({status:"error",message:e.message})}},globalThis.checkApplicability=e=>{if(!Yt)return"[]";try{const n=Yt.evaluate(e);return JSON.stringify(Object.keys(n.missingVariables||{}))}catch(e){return console.error("JS Error checkApplicability: "+e.message),"[]"}},globalThis.getBilan=e=>{if(!Yt)return"0";try{const n=Yt.evaluate(e);return JSON.stringify(n.nodeValue)}catch(e){return"0"}}})();